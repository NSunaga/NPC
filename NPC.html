<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link href="style.css" rel="stylesheet" type="text/css" />
<link href='https://fonts.googleapis.com/css?family=Raleway+Dots|Cinzel+Decorative' rel='stylesheet' type='text/css'>

</head>
<body>
<script src="js/three.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/Detector.js"></script>
<script src="js/jquery-1.10.2.min.js"></script>
<script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="js/CSS3DRenderer.js"></script>
<script src="NuclearPoreComplex.js"></script>
<!--<script src="js/jquery.mousewheel.js"></script>-->
<div id="container"></div>
<div id="info"></div>
<div id="center"></div>
<article id="side">
	<h1 id="articleH1"></h1>
	<p id="articleH2"></p>
</article>
<script>
	var containerElement = document.getElementById("info");
	var info = document.createElement( 'div' );
	info.style.position = 'absolute';
	info.style.top = '10px';
	info.style.width = '100%';
	info.style.textAlign = 'center';
	info.innerHTML = 'Nuclear Pore Complex';
	containerElement.appendChild( info );
	//var container = document.getElementById("container")
	var h1Elem = document.getElementById("articleH1");
	var h2Elem = document.getElementById("articleH2");
	h1Elem.innerHTML ="Nuclear Pore Complex"
	//renderer for cell mesh object
	var renderer = new THREE.WebGLRenderer({ antialias:true });
	renderer.setSize(window.innerWidth, window.innerHeight);
	renderer.setClearColor(0xf0f8ff, 1);
	document.body.appendChild(renderer.domElement);
	
	//scene for cell mesh object
	var scene = new THREE.Scene();
	var camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight);
	camera.position = new THREE.Vector3(100, 600, 800);
	camera.lookAt(new THREE.Vector3(0, 0, 0));
	scene.add(camera);
	console.log(THREE);
	//light for cell mesh object
	var light = new THREE.DirectionalLight(0xcccccc);
	light.position = new THREE.Vector3(0, 0, 1.2);
	var ambient = new THREE.AmbientLight(0x333333);
	scene.add(light);
	scene.add(ambient);

	
	

	
	//var NPC = new NuclearPoreComplex();
	var NPCObject = NPC.structuralObject;
	//console.log(NPCObject);
	scene.add(NPCObject);
	
	//dammy mesh untill finished loading
	var mesh   = new THREE.Object3D(); 
	var loader = new THREE.JSONLoader();
	
	
	//origin is the center
	var origin = new THREE.Vector3();
	
	//material for nuclues	
	var material = new THREE.MeshLambertMaterial({
		//color: 0x778899, specular: 0xffffc, shininess:50, ambient: 0xffffff,
		opacity:0.4
		});
	
	//var proteinTagNo = 0;



	
	//scene for 3D popup
	var scene2 = new THREE.Scene();
	//scene2.add(camera);
	//scene2.add(light);
	
	//XYZ axis display
	looker = new THREE.AxisHelper(5);
	scene.add(looker);
		
		
	var looker;
	var origin = new THREE.Vector3();
	var arySTM = new Array();
	
	
	//Three controls

	var mouseX = -1, mouseY = -1;
	
	
	//mouse point detector
	document.addEventListener('mousemove', function(e) {
		mouseX = (e.clientX / window.innerWidth ) *  2 - 1;
		mouseY = (e.clientY / window.innerHeight) * -2 + 1;
	}, false);
	var flag = 0;
	var mouseWheelPos = 0;
	window.onload = function(){
	//Firefox
	if(window.addEventListener){
			window.addEventListener('DOMMouseScroll', function(e){
				mouseWheelPos = e.detail;
				//console.log(e.detail);
			}, false);
		}
	//IE
	if(document.attachEvent){
			document.attachEvent('onmousewheel', function(e){
				mouseWheelPos = e.wheelDelta;
				//console.log(e.wheelDelta);
			});
		}
	//Chrome
	window.onmousewheel = function(e){
			mouseWheelPos = e.wheelDelta;
			//console.log(e.wheelDelta);
			console.log(flag);
			var projector = new THREE.Projector();
			var pos = new THREE.Vector3(mouseX, mouseY, -1);
			var ray = projector.pickingRay(pos, camera);
			var intersects = ray.intersectObjects(scene.children);
			//mesh material transform
			
			if(e.wheelDelta < -3){
			  //if(intersects.length > 0 && (intersects[0].object.name).substring(-1, 2) == "ST") {
			  	for(var t = 3; t < scene.children.length; t++) {
		            	if(scene.children[t].name.substring(-1, 2) == "ST") {
		                	lnObject = scene.children[t];
		                	//console.log(lnObject);
							scene.remove(lnObject);
							flag = 0;
							//console.log(flag);
						}
			  	}
			  //}
			}
				if(e.wheelDelta >= 6){
					
					//console.log("over 12 nucleus");
					//console.log(intersects[0].object);
					if(intersects.length > 0 && intersects[0].object == cpPMesh){
						//console.log("over 12 over nucleus");
						if(flag == 0){
						h2Elem.innerHTML="Loading Proteins on Nuclear Membrane";
						flag = 1;
						$.ajax({
							type: "GET",
							url: "CentralPoreTest.xml",
							dataType: "xml",
							async:true,
							success : function(xml){
								console.log("success");
								$(xml).find('protein').each(function(){
									var tagCounter = 0;
									var locateProteinTag = $(this);
									$(this).find('TMHMM').each(function(){
										if ($(this).text() != "No_TM"){
											tagCounter += 1;
										}
									});
									if (tagCounter == 1){
										$(this).find('uid').each(function(){
											console.log($(this).text());
											var tagName = $(this).text();
											locateProteinTag.find('protein_function').each(function(){
												arySTM["" + tagName + ""] = $(this).text();
											})
											
											var sigleTMLoader = new THREE.JSONLoader();
											
											sigleTMLoader.load('protein.js', function(geometry) {
												var stMaterial = new THREE.MeshLambertMaterial({
													color: 0xdc143c, specular: 0xffffe0, shininess:50, ambient: 0xffffff,
												});
												eval("var mesh" + tagName + " = new THREE.Mesh(geometry, stMaterial);");
												eval("mesh" + tagName + ".scale = new THREE.Vector3(50, 50, 50);");
												eval("mesh" + tagName + ".name = 'ST" + tagName + "' ;");
												eval("mesh" + tagName + ".id2 = 'ST" + tagName + "' ;");
												var xAxis = new THREE.Vector3(1,0,0);
												xAxis = new THREE.Vector3(1,0,0);
												scene.add(eval("mesh" + tagName));
												var rand = randGen();
												eval("mesh" + tagName + ".position.set(rand[0]*108,rand[1]*108,rand[2]*108);");
												eval("mesh" + tagName + ".rotation = new THREE.Vector3(Math.PI/2, 0, 0);");
												eval("mesh" + tagName + ".lookAt(stickCenter.position);");
												h2Elem.innerHTML="";
											});	
										});
									}
					
								});
							}
						});
					}
					}
				}
	}
	}
	
	
	document.addEventListener('mousedown', function(e){
		//console.log("mouse down");
		var projector = new THREE.Projector();
		var clickMouseX = (e.clientX / window.innerWidth ) *  2 - 1;
		var clickMouseY = (e.clientY / window.innerHeight) * -2 + 1;
		var pos = new THREE.Vector3(clickMouseX, clickMouseY, -1);
		var ray = projector.pickingRay(pos, camera);
		var intersects = ray.intersectObjects(scene.children);
		var target = e.target;
		//console.log((intersects[0].object.name).substring(-1, 2));
		if(target.tagName != "INPUT" && intersects.length > 0 && (intersects[0].object.name).substring(-1, 2) == "ST"){
			var element = document.createElement('div');
			element.style.backgroundColor = 'midnightblue';
			element.style.paddingLeft = "10px";
			element.style.width = "150px";
			element.style.height = "250px";
			element.style.fontsize = "100px";
			element.style.color = 'white';
			element.innerHTML = "</br></br>" + arySTM[(intersects[0].object.name).substring(2, 9)];
			element.innerHTML = element.innerHTML + '<Form><Input type="button" id="button1" value="x" onClick="windowClose();"></Form>';
			//element.appendChild(txt);
			element.style.opacity = '0.6';
			
			object = new THREE.CSS3DObject(element);
			for (var i = 0;i < intersects.length; i++){
				object.position = intersects[i].point;
				//object.rotation = new THREE.Vector3(Math.PI/2, 0, 0);
				//object.lookAt(stickCenter.position);
				scene2.add(object);
			}
			//object.position.x = sphereRandX;
			//object.position.y = sphereRandY;
			//object.position.z = sphereRandZ;
			
		}
	}, false);
	
	function windowClose(){
		console.log("push close button");
		scene2.remove(object);
	};
	
	if(document.getElementById("button1") != null){
	
	$('#button1').hover(
		function(){
			console.log("on close button");
			$(this).css({
				'background-color' : '#ddd'
			});
		});
	}
	var controls = new THREE.OrbitControls(camera);
	controls.center = new THREE.Vector3(0, 0, 0);
	function render() {
		requestAnimationFrame(render);
		controls.update();
		renderer.render(scene, camera);
	};
	render();	
	
	
	
	var renderer2 = new THREE.CSS3DRenderer();
	renderer2.setSize( window.innerWidth, window.innerHeight );
	renderer2.domElement.style.position = 'absolute';
	renderer2.domElement.style.top = 0;
	document.getElementById('container').appendChild(renderer2.domElement);	

	
	var baseTime = +new Date;

	
	//window resize event
	window.addEventListener('resize', 
	function() {
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer2.setSize(window.innerWidth, window.innerHeight);
		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();
	}, 
	false );
</script>
</body>
</html>
